{
  "hash": "964bb8f346684e9ce6e354654d208741",
  "result": {
    "engine": "knitr",
    "markdown": "# Estimating $R_t$\n\n$R_t$ can be defined in 2 ways: as the **instantaneous reproduction number** (see @sec-rt-inst) or as the **case reproduction number** (see @sec-rt-case).\n\n## Instantaneous reproduction number $R_t^i$\n\n::: {#def-rt-inst}\nThe instantaneous reproduction number is the expected number of secondary infections occurring at time $t$, divided by the number of infected individuals, each scaled by their relative infectiousness at time $t$ (an individual's relative infectiousness is based on the generation interval and time since infection) [@gostic2020].\n:::\n\n### Exact calculation\n\nFor a compartmental model (SIR or SEIR), $R_t^i$ can be calculated exactly as [@gostic2020]:\n\n$$R_t^i = \\beta(t) S(t) D$$\n\n-   $\\beta(t)$: the time-varying transmission rate.\n-   $S(t)$: the fraction of the population that is susceptible.\n-   $D$: the mean duration of infectiousness.\n\n### Cori method {#sec-cori}\n\n$$R_t^i = \\frac{I_t}{\\sum_{s = 1}^{t} I_{t - s} w_s}$$\n\n-   $I_t$: the number of infection on day $t$.\n-   $I_{t - s}$: the number of individuals who became infected $s$ days in the past.\n-   $w_s$: the infectivity profile, describes how infectious an individual is $s$ days since infection, $w_s$ dependent on time since infection $s$ but independent of calendar time $t$, and often be approximated by the generation interval [@cori2013].\n-   $I_{t - s} w_s$: we scale the number of individuals who became infected $s$ days in the past by how infectiousness are they still on day $t$ (which is $s$ days after the date they got infected, $w_s$).\n\nLooking back at @def-rt-inst, $R_t^i$ is the expected number of secondary infections occurring at time $t$ ($I_t$), divided by the number of infected individuals ($\\sum_{s = 1}^{t} I_{t - s}$), each scaled by their relative infectiousness at time $t$ ($w_s$).\n\nThe only parametric assumption required by this method is **the form of the generation interval**. The standard assumption is that $w_s$ follows a **discretized gamma distribution**, but any parametric or empirical discrete distribution also work [@gostic2020].\n\n::: {.callout-tip collapse=\"true\"}\n\n## Proofs\n\nThe renewal equation (also called the Euler-Lotka equation [@wallinga2006]) is a cornerstone of demographic theory and backbone of the $R_t$ estimators.\n\n$$b(t) = \\int_{a = 0}^{\\infty} b(t - a) n(a) da$$\n\n-   $b(t)$: the number of female offspring at time $t$.\n-   $b(t - a)$: the number of mothers of age $a$ at time $t$, which is equal to the number of female offspring at time $t - a$.\n-   $n(a)$: the birth ability of mothers of age $a$, scaled by the probability of surviving to age $a$.\n-   $\\int_{a = 0}^{\\infty}$: summing these female offspring over all possible mothers' ages, we obtain the total number of female offspring at time $t$ which is $b(t)$.\n\nThis equation assume that the population displays exponential growth at a fixed growth rate and that the age distribution of the population does not change over time [@wallinga2006].\n\nTo describe epidemic dynamics, the renewal equation is expressed in terms of $I(t)$.\n\n$$I(t) = R_0 S(t) \\int_{s = 0}^{\\infty} I(t - s) w_s ds$$\n\n-   $R_0 S(t) = R_t$: see @def-rt.\n-   $I(t - s)$: the number of individuals who became infected $s$ time points ago in the past.\n-   $w_s$: the infectivity profile, or the probability of how infectiousness are they still at time $t$ (which is $s$ time points after the date they got infected).\n-   $I(t - s) w_s$: we scale the number of individuals who in the past by how infectiousness are they still at time $t$.\n\nNow we transform the equation a bit, and we got something very similar to the Cori method (see @sec-cori).\n\n$$R_t = \\frac{I(t)}{\\int_{s = 0}^{\\infty} I(t - s) w_s ds}$$\n\n:::\n\n### When can we start estimating $R_t^i$?\n\nCori et al. suggest starting estimating $R_t^i$ once those three criteria are fulfilled [@cori2013]:\n\n-   At least after the sliding window size.\n-   At least after one mean serial interval.\n-   At least 12 cases (the initial case + 11) have been observed since the beginning of the epidemic (in a time window): to get a posterior credible interval of 0.3, the time window must comprise at least 11 incident cases.\n\n### Key considerations\n\nSource: Dr. Anne Cori's [webinar](https://www.youtube.com/watch?v=wv3BecZD5DU).\n\n-   Temporal resolution: we can't apply the $R_t^i$ method when the time step of observation is too large (\\> mean generation interval).\n-   Spatial resolution: ideally use a spatial scale that you can distinguish locally infected cases from imported cases.\n-   $R_t^i$ is very sensitive to the size of the sliding window: small windows can lead to highly variable estimates with wide credible intervals, whereas longer windows lead to smoothed estimates with narrower credible intervals. Perhaps also consider at least 11 incident cases in a sliding window to get a posterior credible interval of 0.3 [@cori2013].\n\n![](img/rnum/rt-window.png)\n\n## Case reproduction number $R_t^c$\n\n::: {#def-rt-case}\nThe case or cohort reproduction number is the expected number of secondary infections that an individual who becomes infected at time $t$ will eventually cause as they progress through their infection [@gostic2020].\n:::\n\n### Exact calculation {#sec-rt-case-exact}\n\n$$R_t^c = \\int_{u = t}^{\\infty} R_u^i w_{u-t} du$$\n\n-   $R_u^i$: the instantaneous reproduction number of current infected cases at time $u$, starting from $t$ to the end of their infectious period $\\infty$.\n-   $w_{u-t}$: the infectiousness of them at that time.\n\n### Wallinga and Teunis method\n\nThere are 3 steps [@gostic2020]:\n\n**Step 1**. Estimate the likelihood that case $j$ (infected at time $t_j$) infected case $i$ (at time $t_i$).\n\n$$p_{ij} = \\frac{w_{t_i - t_j}}{\\sum_{i \\neq k} w_{t_i - t_k}}$$\n\n-   $\\sum_{i \\neq k} w_{t_i - t_k}$: sum of the infectiousness of all cases (other than $i$) infects case $i$.\n\n**Step 2**. Compute the individual reproduction number of case $j$.\n\n$$R_j = \\sum_i p_{ij}$$\n\n**Step 3**. Compute the case reproduction number at time $t$, it is the expected value of $R_j$ for all individuals infected at time $t$.\n\n$$R_t^c = \\mathbb{E}(R_j)$$\n\n## Compare $R_t^i$ and $R_t^c$\n\nThere are several important differences [@gostic2020]:\n\n1.  Instantaneous $R_t^i$ is real-time estimation and only use data from before time $t$, while case $R_t^c$ is inherently forward-looking.\n\n-   **Instantaneous** $R_t^i$ **overestimates** $R_t$ early in the time series, because any infections that occurred before the first observed date are missing terms in the denominator (the $I_{t - s}$ in @sec-cori, data is left-truncated at the beginning).\n\n-   **Case** $R_t^c$ **underestimates** $R_t$ at the end of the time series, because it relies on time points not yet observed which become missing terms in the integral (the $R_u^i$ in @sec-rt-case-exact, data is right-truncated at the end).\n\n2.  Case $R_t^c$ is shifted forward in time relative to instantaneous $R_t^i$, produces leading estimates of $R_t$ because it uses data from time points **after** $t$, whereas the $R_t^i$ uses data from time points **before** $t$.\n\n::: callout-important\nOverall, **for real-time analyses** aiming to **infer the impact of changes in policy**, behavior, or other extrinsic factors on transmission, the **instantaneous reproductive number** will provide more temporally accurate estimates and is **most appropriate**.\n:::\n\n## Potential biases\n\n$R_t$ is a **value** in specific **time**, therefore there are 2 potential forms of bias in $R_t$ estimates [@gostic2020]:\n\n-   **Accuracy** (the value): Systematic over- or underestimation caused by misspecification of the generation interval. Mostly impact when $R_t$ is substantially \\> 1 (e.g., the beginning of COVID-19 when $R_t$ is relatively high) or \\< 1 (e.g., after a very effective intervention then $R_t$ might be low).\n\n-   **Timeliness** (the time): Temporal inaccuracy that $R_t$ estimates may be leading or lagging the true date, has several possible causes and can be difficult to avoid.\n\n![](img/rnum/gen-ser-int.png)\n\n> Figure from Sender et al. [@sender2022].\n\n### Generation interval\n\n::: {#def-gen-int}\nGeneration interval is the time from the infection of a primary case to infection of the cases he/she generates [@cori2013].\n:::\n\nIf we match this to an SEIR model, the generation interval starts when the infector enters the E compartment (meaning they got infected). The latest time they can infect an infectee is at the end of their residence in the I compartment (they are infectious). Therefore, generation interval is the sum of residence times in compartments E and I [@gostic2020].\n\nThe mean generation interval **decreases** when susceptible persons are at risk of infectious contact from **multiple sources**. Because when a susceptible person has multiple potential infectors, there is a \"race\" to infect him/her in which only the first infectious contact leads to infection [@kenah2008].\n\n![](img/rnum/mean-gen-int-bias.png)\n\n> Biases from misspecification of the generation interval mean (A) or variance (B) [@gostic2020].\n\n-   If **mean** generation interval is set **too high**, $R_t$ will be **more extreme** (too high when true $R_t > 1$ and too low when true $R_t < 1$).\n-   If **mean** generation interval is set **too low**, $R_t$ will be **closer to 1** than the true value.\n-   The effect of the mean generation interval is large when true $R_t$ further from 1. Therefore, **this bias may be greatest at the early epidemic**, when true $R_t$ is high, together with highly uncertain generation interval and limited data.\n\nTools like `EpiEstim` and `EpiNow2` allow users to specify the prior variance of the mean and standard deviation. However, bear in mind that uncertainty around an incorrect generation interval only widen the 95% credible interval, but will not shift the estimates toward the truth and will not correct this bias.\n\n### Serial interval\n\n::: {#def-ser-int}\nSerial interval is the time between symptom onset in an infector–infectee pair [@gostic2020].\n:::\n\nSerial interval is more easily observed than generation interval and often used in its place. Although the serial and generation intervals are often conflated, there are important differences [@gostic2020]:\n\n-   Serial interval and generation interval usually have the same mean, but different variances.\n-   Serial interval can be negative (when the symptom onset of infector is later than infectee, such as in COVID-19), generation interval is always positive.\n\nThe distributions of the serial interval and the generation interval are identical in these scenarios [@cori2013]:\n\n-   For diseases such as influenza, SARS, measles, and smallpox, it is expected that infectiousness starts only around the time of symptom onset.\n-   When the infectiousness profile after symptoms is independent of the incubation period.\n\n### Delays\n\n![](img/rnum/delays.png)\n\n> Adjusting for delays [@gostic2020].\n\nIf $d$ is the delay from infection to observation, then observations at time $t$ inform $R_{t − d}$, not $R_t$.\n\nIf the distribution of delays can be estimated, then $R_t$ can be estimated in 2 steps:\n\n1.  Infer the underlying time series of infections.\n2.  Input the adjusted time series into an $R_t$ estimation method.\n\n## Code\n\n### EpiEstim\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(EpiEstim)\nlibrary(ggplot2)\n```\n:::\n\n\nThe input data\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata(Flu2009)\n\ndf <- Flu2009$incidence\nhead(df)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"dates\"],\"name\":[1],\"type\":[\"date\"],\"align\":[\"right\"]},{\"label\":[\"I\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"2009-04-27\",\"2\":\"1\",\"_rn_\":\"1\"},{\"1\":\"2009-04-28\",\"2\":\"1\",\"_rn_\":\"2\"},{\"1\":\"2009-04-29\",\"2\":\"0\",\"_rn_\":\"3\"},{\"1\":\"2009-04-30\",\"2\":\"2\",\"_rn_\":\"4\"},{\"1\":\"2009-05-01\",\"2\":\"5\",\"_rn_\":\"5\"},{\"1\":\"2009-05-02\",\"2\":\"3\",\"_rn_\":\"6\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\nLet have a look at the data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(df, aes(x = dates, y = I)) +\n  geom_point() +\n  labs(x = \"Day\", y = \"Incidence\") +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](rt_files/figure-html/unnamed-chunk-3-1.svg)\n:::\n:::\n\n\n####\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod <- estimate_R(\n  incid = df, \n  method = \"parametric_si\", \n  config = make_config(\n    list(\n      mean_si = 2.6, \n      std_si = 1.5\n    )\n  )\n)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nDefault config will estimate R on weekly sliding windows.\n    To change this change the t_start and t_end arguments. \n```\n\n\n:::\n:::\n\nNoted that the default config will estimate R on weekly sliding windows (day 2 to day 8).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(mod$R)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"t_start\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"t_end\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Mean(R)\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Std(R)\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Quantile.0.025(R)\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Quantile.0.05(R)\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Quantile.0.25(R)\"],\"name\":[7],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Median(R)\"],\"name\":[8],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Quantile.0.75(R)\"],\"name\":[9],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Quantile.0.95(R)\"],\"name\":[10],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Quantile.0.975(R)\"],\"name\":[11],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"2\",\"2\":\"8\",\"3\":\"1.735798\",\"4\":\"0.4091314\",\"5\":\"1.0287437\",\"6\":\"1.121933\",\"7\":\"1.445198\",\"8\":\"1.703761\",\"9\":\"1.991520\",\"10\":\"2.458972\",\"11\":\"2.624781\",\"_rn_\":\"1\"},{\"1\":\"3\",\"2\":\"9\",\"3\":\"1.749168\",\"4\":\"0.3647267\",\"5\":\"1.1088223\",\"6\":\"1.195480\",\"7\":\"1.491345\",\"8\":\"1.723884\",\"9\":\"1.979457\",\"10\":\"2.389121\",\"11\":\"2.533119\",\"_rn_\":\"2\"},{\"1\":\"4\",\"2\":\"10\",\"3\":\"1.537058\",\"4\":\"0.3074116\",\"5\":\"0.9947030\",\"6\":\"1.068694\",\"7\":\"1.320090\",\"8\":\"1.516613\",\"9\":\"1.731761\",\"10\":\"2.075176\",\"11\":\"2.195540\",\"_rn_\":\"3\"},{\"1\":\"5\",\"2\":\"11\",\"3\":\"1.431839\",\"4\":\"0.2705921\",\"5\":\"0.9514466\",\"6\":\"1.017661\",\"7\":\"1.241251\",\"8\":\"1.414830\",\"9\":\"1.603900\",\"10\":\"1.904047\",\"11\":\"2.008849\",\"_rn_\":\"4\"},{\"1\":\"6\",\"2\":\"12\",\"3\":\"1.422725\",\"4\":\"0.2515046\",\"5\":\"0.9731426\",\"6\":\"1.035808\",\"7\":\"1.245996\",\"8\":\"1.407932\",\"9\":\"1.583340\",\"10\":\"1.860107\",\"11\":\"1.956336\",\"_rn_\":\"5\"},{\"1\":\"7\",\"2\":\"13\",\"3\":\"1.635373\",\"4\":\"0.2523436\",\"5\":\"1.1786332\",\"6\":\"1.243590\",\"7\":\"1.458847\",\"8\":\"1.622413\",\"9\":\"1.797779\",\"10\":\"2.071372\",\"11\":\"2.165745\",\"_rn_\":\"6\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(mod)\n```\n\n::: {.cell-output-display}\n![](rt_files/figure-html/unnamed-chunk-6-1.svg)\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntmp <- df[df$dates < as.Date(\"2009-05-11\"),]\nmod <- estimate_R(\n  incid = tmp, \n  method = \"parametric_si\", \n  config = make_config(\n    list(\n      mean_si = 2.6, \n      std_si = 1.5\n    )\n  )\n)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nDefault config will estimate R on weekly sliding windows.\n    To change this change the t_start and t_end arguments. \n```\n\n\n:::\n\n```{.r .cell-code}\nhead(mod$R)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"t_start\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"t_end\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Mean(R)\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Std(R)\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Quantile.0.025(R)\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Quantile.0.05(R)\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Quantile.0.25(R)\"],\"name\":[7],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Median(R)\"],\"name\":[8],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Quantile.0.75(R)\"],\"name\":[9],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Quantile.0.95(R)\"],\"name\":[10],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Quantile.0.975(R)\"],\"name\":[11],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"2\",\"2\":\"8\",\"3\":\"1.735798\",\"4\":\"0.4091314\",\"5\":\"1.0287437\",\"6\":\"1.121933\",\"7\":\"1.445198\",\"8\":\"1.703761\",\"9\":\"1.991520\",\"10\":\"2.458972\",\"11\":\"2.624781\",\"_rn_\":\"1\"},{\"1\":\"3\",\"2\":\"9\",\"3\":\"1.749168\",\"4\":\"0.3647267\",\"5\":\"1.1088223\",\"6\":\"1.195480\",\"7\":\"1.491345\",\"8\":\"1.723884\",\"9\":\"1.979457\",\"10\":\"2.389121\",\"11\":\"2.533119\",\"_rn_\":\"2\"},{\"1\":\"4\",\"2\":\"10\",\"3\":\"1.537058\",\"4\":\"0.3074116\",\"5\":\"0.9947030\",\"6\":\"1.068694\",\"7\":\"1.320090\",\"8\":\"1.516613\",\"9\":\"1.731761\",\"10\":\"2.075176\",\"11\":\"2.195540\",\"_rn_\":\"3\"},{\"1\":\"5\",\"2\":\"11\",\"3\":\"1.431839\",\"4\":\"0.2705921\",\"5\":\"0.9514466\",\"6\":\"1.017661\",\"7\":\"1.241251\",\"8\":\"1.414830\",\"9\":\"1.603900\",\"10\":\"1.904047\",\"11\":\"2.008849\",\"_rn_\":\"4\"},{\"1\":\"6\",\"2\":\"12\",\"3\":\"1.422725\",\"4\":\"0.2515046\",\"5\":\"0.9731426\",\"6\":\"1.035808\",\"7\":\"1.245996\",\"8\":\"1.407932\",\"9\":\"1.583340\",\"10\":\"1.860107\",\"11\":\"1.956336\",\"_rn_\":\"5\"},{\"1\":\"7\",\"2\":\"13\",\"3\":\"1.635373\",\"4\":\"0.2523436\",\"5\":\"1.1786332\",\"6\":\"1.243590\",\"7\":\"1.458847\",\"8\":\"1.622413\",\"9\":\"1.797779\",\"10\":\"2.071372\",\"11\":\"2.165745\",\"_rn_\":\"6\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\nplot(mod)\n```\n\n::: {.cell-output-display}\n![](rt_files/figure-html/unnamed-chunk-7-1.svg)\n:::\n:::\n\n\n\n### EpiNow2\n",
    "supporting": [
      "rt_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}