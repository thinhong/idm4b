{
  "hash": "c4f4d7fd45b53222bc3699b00e04b73d",
  "result": {
    "engine": "knitr",
    "markdown": "# Maximum likelihood estimation\n\n::: {.callout-note}\n\n## Preparation\n\nDownload influenza incidence data here:\n\n\n{{< downloadthis data/flu_inc.rds dname=\"flu_inc\" label=\"flu_inc.rds\" type=light >}}\n\n\n\n:::\n\n## Methods\n\nThe maximum likelihood estimation follows 4 steps:\n\n- **Step 1**. Write down the likelihood function $L(\\theta)$. Likelihood function is a function of $\\theta$, which is the product of the $n$ mass/density function terms of the observed values $y_i$.\n\n$$L(\\theta) = \\prod_{i = 1}^{n} f_Y(y_i| \\theta)$$\n\n- **Step 2**. Take the natural log of the likelihood $log L(\\theta)$, or log-likelihood. The production in log likelihood now becomes the sum. See @sec-calib-loglik for more details.\n\n$$log L(\\theta) = \\sum_{i = 1}^{n} f_Y(y_i| \\theta)$$\n\n- **Step 3**. Take the negative log likelihood $- log L(\\theta)$. Because optimizers work by minimizing a function, we have to work on negative log likelihood. See @sec-calib-negloglik for more details.\n\n$$- log L(\\theta) = - \\sum_{i = 1}^{n} f_Y(y_i| \\theta)$$\n\n- **Step 4**. The optimizer try different values of $\\theta$ in the paramater space $\\Theta$ for which negative log likelihood $- log L(\\theta)$ is minimized.\n\n## Code\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyr)\nlibrary(deSolve)\nlibrary(bbmle)\nlibrary(ggplot2)\nlibrary(RColorBrewer)\n```\n:::\n\n\nWe will use the same data of a H1N1 influenza outbreak in an elementary school in @sec-lse-code and fit the deterministic SEIR model with code @lst-seir-det.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- readRDS(\"data/flu_inc.rds\")\n```\n:::\n\n::: {.cell}\n\n:::\n\n\nLooking at the original paper, the school has 370 students [@cauchemez2011]. So we set the initial values as below.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nS0 <- 369\nE0 <- 0\nI0 <- 1\nR0 <- 0\n```\n:::\n\n\n- **Step 1**. Write down the likelihood function $L(\\theta)$.\n\nWe assume the incidence data is generated from a normal distribution with mean $\\mu_{inc}$ is the predicted incidence and a standard deviation $\\sigma_{inc}$.\n\n$$L(\\theta) = \\prod_{i = 1}^{n} \\mathcal{N}(\\mu_{inc}, \\sigma_{inc})$$\n\nWe use the `dnorm()` function to define this likelihood.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndnorm(x = data, mean = pred, sd = sd_inc)\n```\n:::\n\n\n- **Step 2**. Take the natural log of the likelihood $log L(\\theta)$, product becomes sum.\n\n$$log L(\\theta) = \\sum_{i = 1}^{n} \\mathcal{N}(\\mu_{inc}, \\sigma_{inc})$$\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsum(dnorm(x = data, mean = pred, sd = sd_inc, log = T))\n```\n:::\n\n\n- **Step 3**. Take the negative log likelihood $- log L(\\theta)$.\n\n$$- log L(\\theta) = - \\sum_{i = 1}^{n} \\mathcal{N}(\\mu_{inc}, \\sigma_{inc})$$\n\n\n::: {.cell}\n\n```{.r .cell-code}\n- sum(dnorm(x = data, mean = pred, sd = sd_inc, log = T))\n```\n:::\n\n\n- **Step 4**. Pass the negative log likelihood $- log L(\\theta)$ to the optimizer.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmll <- function(beta, sigma, gamma, sd_inc) {\n  # Make sure that parameters are positive\n  beta <- exp(beta) \n  gamma <- exp(gamma)\n  sd_inc <- exp(sd_inc)\n  pred <- seir_mod(beta = beta, sigma = sigma, gamma = gamma, S0 = S0, E0 = E0, I0 = I0, R0 = R0, times = 0:(length(df$inc) - 1))\n  pred <- pred$Inc\n  # Return the negative log likelihood\n  - sum(dnorm(x = df$inc, mean = pred, sd = sd_inc, log = T))\n}\n\nstarting_param_val <- list(beta = 0.004, sigma = 0.5, gamma = 0.5, sd_inc = 1)\n\nestimates <- mle2(minuslogl = mll, start = lapply(starting_param_val, log), method = \"Nelder-Mead\")\n\nsummary(estimates)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nMaximum likelihood estimation\n\nCall:\nmle2(minuslogl = mll, start = lapply(starting_param_val, log), \n    method = \"Nelder-Mead\")\n\nCoefficients:\n        Estimate Std. Error  z value     Pr(z)    \nbeta   -5.088100   0.091028 -55.8960 < 2.2e-16 ***\nsigma   2.089725   0.287055   7.2799 3.341e-13 ***\ngamma   0.575974   0.091507   6.2943 3.088e-10 ***\nsd_inc  0.530695   0.099593   5.3286 9.896e-08 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n-2 log L: 198.8645 \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nparams <- exp(coef(estimates))\n```\n:::\n\n\nCompare the model with data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npred <- seir_mod(beta = params[1], sigma = params[2], gamma = params[3], S0 = S0, E0 = E0, I0 = I0, R0 = R0, times = df$day)\ndf_plot <- pred[,c(\"time\", \"Inc\")]\n\nmy_palette <- brewer.pal(11, \"PuOr\")[c(10, 1, 4, 3, 8)]\n\nggplot(df_plot, aes(x = time, y = Inc)) +\n  geom_point(color = my_palette[3]) +\n  geom_line(color = my_palette[3]) +\n  geom_point(data = df, aes(x = day, y = inc)) +\n  labs(x = \"Day\", y = \"Incidence\") +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](mle_files/figure-html/unnamed-chunk-10-1.svg)\n:::\n:::\n",
    "supporting": [
      "mle_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}